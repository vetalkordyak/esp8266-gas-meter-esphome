# Лічильник імпульсів газового лічильника на ESP8266 (ESPhome + Home Assistant)

Цей проект реалізує лічильник імпульсів газового лічильника за допомогою ESPhome, ESP8266 (D1 Mini v4.0.0) та датчика Холла (49E). Він зчитує імпульси з механічного газового лічильника та передає дані до Home Assistant.

Ця інтеграція дуже дешева, оскільки потребує дуже мало компонентів, і всі вони є дешевими та доступними.

**Приблизна вартість компонентів:**
- ESP8266 D1 Mini v4.0.0: ~$1.5–3 ([Купити на AliExpress](https://a.aliexpress.com/_EwQjbHk))  
  *(Це плата, яку я використовував, але підійде будь-яка плата ESP8266 або ESP32.)*
- Датчик Холла 49E: ~$0.20–0.50 ([Купити на AliExpress](https://a.aliexpress.com/_EyKh9nC))
- Проводи: ~$0.10
- (Опціонально) 3D друкована кріплення: ~$0.50

**Загальна приблизна вартість:** ~$2.3–4

## Особливості

- Зчитує імпульси газового лічильника за допомогою датчика Холла.
- Зберігає кількість імпульсів у флеш-пам'яті для відновлення після вимкнення живлення.
- Публікує загальне споживання газу та кількість імпульсів у Home Assistant.
- Кнопки для ручної корекції (додавання/віднімання імпульсів).
- Веб-сервер та підтримка OTA оновлень.
- Включає файл для 3D друку кріплення для лічильника Gridwe Base Q G4.

## Схема підключення

```
D1 Mini v4.0.0         Датчик Холла 49E
+--------------+   +----------------+
|      3V3     |---| VCC (Pin 1)    |
|      G       |---| GND (Pin 2)    |
|      A0      |---| Vout (Pin 3)   |
+--------------+   +----------------+
```

**Деталі підключення:**
- Підключіть VCC датчика Холла до 3.3V на D1 Mini.
- Підключіть GND датчика Холла до GND на D1 Mini.
- Підключіть OUT датчика Холла до A0 (аналоговий вхід) на D1 Mini.

## Налаштування

Щоб налаштувати проект під себе, змініть наступні параметри у `project.yaml`:

```yaml
globals:
  - id: m3_gas_per_pulse
    type: float
    initial_value: '0.01'         # <-- Вкажіть значення вашого лічильника (м³ за імпульс)
  - id: total_gas_m3_start_value
    type: float
    initial_value: '113.933'      # <-- Вкажіть поточне значення вашого лічильника (м³)
wifi:
  ssid: !secret wifi_ssid         # <-- Вкажіть ваш SSID WiFi у secrets.yaml
  password: !secret wifi_password # <-- Вкажіть ваш пароль WiFi у secrets.yaml
sensor:
  - platform: homeassistant
    id: pulse_counter_from_ha
    entity_id: input_number.gas_impulse_count # <-- Переконайтеся, що цей хелпер існує у Home Assistant
```

## Хелпер Home Assistant: `input_number.gas_impulse_count`

Цей проект потребує хелпера Home Assistant під назвою `input_number.gas_impulse_count`.  
Це [Input Number](https://www.home-assistant.io/integrations/input_number/) — сутність у Home Assistant, яка використовується для збереження та відновлення значення кількості імпульсів.  
Вона дозволяє ESP8266 синхронізувати кількість імпульсів із Home Assistant, щоб значення можна було відновити після перезавантаження пристрою або вимкнення живлення.

### Важливе налаштування пристрою ESPHome

Коли ви додаєте пристрій ESPHome до Home Assistant, перейдіть до налаштувань пристрою та увімкніть  
**"Allow the device to perform Home Assistant actions"**.

Це необхідно для того, щоб ESP8266 міг викликати сервіси Home Assistant, наприклад, оновлювати хелпер `input_number.gas_impulse_count` з останнім значенням кількості імпульсів.  
Без цього дозволу пристрій не зможе синхронізувати дані або виконувати дії у Home Assistant.

### Як створити хелпер

1. У Home Assistant перейдіть до **Налаштування** → **Пристрої та сервіси** → **Хелпери**.
2. Натисніть **Створити хелпер** та виберіть **Число**.
3. Вкажіть назву `Gas Impulse Count`.
4. Встановіть мінімальне значення `0`.
5. Встановіть максимальне значення вище вашої очікуваної кількості імпульсів (наприклад, `9999999999`).
6. Встановіть крок `1`.
7. Опціонально, вкажіть одиницю вимірювання `imp`.
8. Натисніть **Створити**.

Після створення сутність буде доступна як `input_number.gas_impulse_count`.

Приклад конфігурації у `project.yaml`:
```yaml
sensor:
  - platform: homeassistant
    id: pulse_counter_from_ha
    entity_id: input_number.gas_impulse_count # <-- Це має відповідати entity_id вашого хелпера
```

## Хелпери Home Assistant для щоденного та місячного споживання газу

Якщо ви хочете відстежувати, скільки газу споживається за день або за місяць, ви можете використовувати [Utility Meter](https://www.home-assistant.io/integrations/utility_meter/) хелпери у Home Assistant.

### Як створити хелпери для щоденного та місячного споживання газу

1. У Home Assistant перейдіть до **Налаштування** → **Пристрої та сервіси** → **Хелпери**.
2. Натисніть **Створити хелпер** та виберіть **Utility Meter**.
3. Вкажіть **Джерело** як ваш сенсор загального споживання газу (наприклад, `sensor.total_gas`).
4. Вкажіть **Тип** як `daily` для щоденного відстеження або `monthly` для місячного.
5. Вкажіть назву, наприклад, `Daily Gas Consumption` або `Monthly Gas Consumption`.
6. Натисніть **Створити**.

Приклад YAML конфігурації для досвідчених користувачів (додайте до вашого `configuration.yaml`):

```yaml
utility_meter:
  daily_gas:
    source: sensor.total_gas
    cycle: daily
  monthly_gas:
    source: sensor.total_gas
    cycle: monthly
```

Після налаштування у вас будуть нові сутності, такі як `sensor.daily_gas` та `sensor.monthly_gas`, які показують кількість газу, спожитого за поточний день та місяць.

## Використання

1. Прошити ESP8266 за допомогою ESPhome, використовуючи наданий `project.yaml`.
2. Встановіть пристрій біля вашого газового лічильника так, щоб датчик Холла міг виявляти магніт, що проходить повз.
3. Інтегруйте пристрій із Home Assistant для моніторингу та корекцій.

## Як це працює

На останньому коліщатку газового лічильника виробник приклеює маленький магніт.  
Датчик Холла (такий як у ноутбуках для визначення закриття кришки) розташовується поруч із цим коліщатком, щоб вимірювати силу магнітного поля.  
Коли коліщатко обертається, магнітне поле, яке виявляє датчик Холла, змінюється — стає сильнішим, коли магніт наближається, і слабшим, коли він віддаляється.

Кожен повний оберт коліщатка відповідає фіксованому об'єму газу, що проходить через лічильник (наприклад, 1 оберт = 0.01 м³ газу).  
ESP8266 зчитує аналогове значення з датчика Холла та визначає момент проходження магніту, рахуючи кожен імпульс.  
Таким чином, пристрій може точно відстежувати споживання газу, рахуючи кількість обертів коліщатка.

### Чому варто використовувати аналоговий датчик Холла?

Важливо використовувати **аналоговий датчик Холла** (такий як 49E), а не цифровий:

- **Аналогові датчики Холла** забезпечують безперервний діапазон значень, що представляють силу магнітного поля. Це дозволяє точно визначати положення магніту та плавно налаштовувати поріг.
- **Цифрові датчики Холла** видають лише HIGH або LOW (вкл/викл), що може бути ненадійним для цього застосування. Магнітне поле від магніту лічильника часто слабке та змінюється поступово, тому цифровий датчик може не спрацьовувати стабільно або пропускати імпульси.

Використання аналогового датчика забезпечує точне та надійне виявлення імпульсів для моніторингу газового лічильника.

## Файл для 3D друку

Проект включає файл для 3D друку кріплення датчика Холла для газового лічильника Gridwe Base Q G4. Використовуйте цей файл для зручного встановлення.

## Приклад та скріншоти

**Приклад реалізації апаратної частини:**  
![Приклад реалізації апаратної частини](photo.png)

**Скріншот інтеграції в Home Assistant (ваш інтерфейс буде англійською):**  
![Скріншот інтеграції в Home Assistant](haos.png)

## Ліцензія

Цей проект ліцензований під **GPL-3.0 license**.

### Що дозволено:
- Використовувати, змінювати та ділитися кодом вільно.
- Створювати власні проекти на основі цього коду.
- Розповсюджувати модифіковані версії, за умови використання ліцензії GPL-3.0.

### Що заборонено:
- Розповсюджувати код або похідні під більш обмежувальною ліцензією.
- Видаляти або змінювати умови ліцензії при поширенні або публікації.

Для детальної інформації дивіться [GPL-3.0 license](https://www.gnu.org/licenses/gpl-3.0.html).

